# 1 计算机网络概述

## 什么是网络

网络是一个连接了物体、设备、人的复杂系统、

相较于电信网/电视网，计算机网络共享的资源由终端计算机处理，可以共享多种资源 

## Data Networks Classifications 数据网络分类

### LAN(Local Area Networks)

* 一般通过广播方式通讯

- 本地运作 (覆盖区域小)
- 多用户通道
- 高速率需求 (高达10Gbps)
- 错误率可以轻松控制

### WAN(Wide Area Networks)

* 一般通过点对点方式通信

- 在大范围运作
- 通过串行链路、光链路连接
- 通常速度慢
- 错误率不好控制

### 局域网设备

hub 在第一层将设备连接起来 多端口中继器

bridge 网桥 基于MAC地址将局域网分段 第二层

switch 多端口网桥 全带宽 第二层

router 路由器 ip地址划分进行路径选择 报文转发 第三层

### 广域网设备

router 路径选择 报文转发

modem 调制解调器 CSU通道服务单元/DSU数据服务单元 模拟转为数字 远程LAN链接 

### 局域网服务和广域网服务

LAN：以太网，最受欢迎

WAN：种类多

### Internet

商业化后 用户通过ISP(Internet service provider)接入Internet 

ISP层次不同 

主机A->本地ISP->第二层ISP->NAP->第一层ISP->NAP->第二层ISP->本地ISP->主机B

![image-20210524102100993](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524102100993.png)

## Data

数据通过01序列传输，但不是01本身，需要解码

### Data Packets

为了使传输双方理解数据，规范传输标准，对不同的传输层次设置不同的数据格式

OSI参考模型中：网络层-packets 数据链路层-frames 数据段层-segments

好处：

计算机系统为分时操作系统 分成报文可以同时处理多个

某个报文丢失，重新传输丢失的一小块即可，保证效率

每个报文可以独立传输，可以选择当前最优路径

### Protocol 协议

为传输计算机网络通讯进行保障 和终端操作系统无关 不同系统可以通过相同的协议进行通信

类似于语言 语法就是协议的数据结构 语用/俗语 相当于协议中的上下文处理关系 

数据传输规则 报文中内容可以不同

### Source and Destination 源和目的

很多时候 通讯都是随机的 通讯时一般都是弱联系 没有打好招呼

目的告诉传输者报文发送到哪里 源告诉传输者报文哪里来的 多用于重新传输

### Media Types 传输介质

电：同轴电缆 粗缆 细缆 双绞线 UTP-非屏蔽双绞线 

光：光缆 速率快 不像电流 更加稳定

空气：无限传输 无需介质

### Digital Bandwidth 带宽

传输能力的度量-传输上限

单位bps bits为传输单位 传输时将字节转为位再计算带宽

### Throughput 通量

通量为实际网络传输量 因此 通量<=带宽

## Open System Interconnection Model OSI参考模型

 开放性系统互连参考标准

从一个发送点到达另一个终端  分层后 每个层次进行特定的任务

OSI把网络分为7层

1. 物理层 Physical：二进制传输

   keywords：信号&介质

   定义了传输介质，传输规格：信号等级/传输速率/信号规格 

   不做管理和控制

2. 数据链路层 Data Link：介质访问

   keywords：帧&MAC 介质访问控制

   基于帧的格式判断传输的数据是否正确并做相应的控制

   如果服务于多个用户，还要管理介质访问，避免冲突

3. 网络层 Networks：路径选择

   keywords：路径选择，基于ip地址设备联通

   跨距离远 地理上分隔开的连接

4. 传输层 Transport：终端与终端的通讯

   keywords：可靠性，流控制，错误修改

   网络系统同时收到不同报文 要发送给不同终端

   把数据分成段 并且转为数据流 传输完判断 确定数据正确再传给上层

5. 会话层 Session：进程间通讯时用户的交流

   keywords：会话

   在双方通讯时设置checkpoint确认双方是否同步以及进程控制

6. 表示层 Presentation：通讯时表示格式标准

   keywords ：Common Format 

   数据格式

7. 应用层 Application：给用户交互接口

   keywords： Browser 用户界面

好处：减少网络复杂程度/更标准化/根据层次确定产品定位 实现网络工程化 

Application Layers 应用层次：5/6/7

用户程序涉及的部分

Data Flow Layers 数据流层：1/2/3/4

网络通讯由这四层负责

OSI分层中的协议

 ![image-20210524112215333](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524112215333.png)

### Data Encapsulation 数据封装

 ![image-20210524112539119](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524112539119.png)

### Peer to Peer Communications

 ![image-20210524115216395](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524115216395.png)

## TCP/IP Model 参考模型

TCP/IP只有4层

 ![image-20210524115322525](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524115322525.png)

应用层对应OSI 5/6/7三层 对应软件相关事宜：界面处理、标准化等

传输层对应OSI 4 实现数据传输 详见OSI-4

Internet Layer 对应OSI-3 负责联通、连接和传输报文 并不要求可靠性

Network Access Layer 网络接入层 也叫 host-to-network Layer 对应OSI-1&2 

### TCP/IP 相关协议

 ![image-20210524193111141](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524193111141.png)

向上能兼容应用，向下能兼容介质

*FTP* - File Transfer Protocol 文件传输协议

*HTTP* -  Hypertext Transfer Protocol 超文本传输协议

*SMTP* - Simple Mail Transfer protocol 简单邮件传输协议 (主要对应发送

*DNS* - Domain Name System 域名解析系统

*TFTP* - Trivial File Transfer Protocol 简单文件传输协议

## Network Topology 网络拓扑

定义了网络的结构

物理层面：把node具体的连接起来--介质的具体分布

逻辑层面：定义了介质的访问控制--介质如何被host访问

### Bus 总线型

 ![image-20210524194142311](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524194142311.png)

每个host都共享总线

物理层面：

​	优点：连接方便，成本低

​	缺点：总线出现折损，整个线路都无法使用

逻辑层面：

​	每个节点都能获取总线信号，如果多个节点同时向总线发送信号则会出现冲突

### Ring 环形

 ![image-20210524194536452](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524194536452.png)

物理层面：

​	所有设备都直接通过环彼此相连 -- daisy-chain

逻辑层面：

​	为了避免冲突，不允许同时使用 -- 令牌环 拿到令牌有一个时间窗口来访问介质

### Dual Ring 双环

有两个环同时接入，也需要令牌，内环只是备用，当外环损坏就切换到内环

物理层面：

​	更可靠可行

逻辑层面：

​	双环类似两个独立的环，但这两个环同一时间只使用一个

### Star 星形

 ![image-20210524195143403](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524195143403.png)



有一个中间节点将其他节点连接起来

物理层面：

​	优点：所有其他节点通讯都可以通过中心节点转发，无需经过其他节点，使得通讯更加安全

​	缺点：中心节点负担大，性能需要加强，如果中心节点瘫痪则无法使用

逻辑层面：

​	所有信息的流都会经过中心节点

### Tree 树/层次结构

越往下视野越小，适用于有逻辑层次划分的节点

物理层面：

​	树干（trunk）是拥有多层分支的线

逻辑层面：

​	信息流是分层的

### Complete/Mesh 渔网形

物理层面：	

​	任意两节点都相连

​	优点：最大的连通性和可靠性

​	缺点：花费大

逻辑层面：

​	拓扑的性能极依赖于所使用的设备

Cellular 蜂窝形

物理层面：

​	蜂窝拓扑使用与无线网络技术，一般来说比较低效，需要相当的算法设计

## Network Devices

设备可以分为两大类

* 边缘节点 -- 终端设备：主机、打印机等

  一般工作层次比较复杂，功能齐全

* 中间节点 -- 中间设备：路由器、交换机等

### NICs Net Interface Controller 网卡 

第二层的设备

每个网卡都有一个MAC地址，是固定的

串行并行转换

 ![image-20210524213010037](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524213010037.png)

终端设备和中间设备都需要网卡

### Media 介质

Layer 1 电信号/光信号进行传输

### Repeater 中继器

Layer 1 连接两个端口 信号的识别放大 延长介质

### Hub 集线器

Layer 1 连接多个端口 Multiple Repeater

逻辑上使用总线方式连接

### Bridges 网桥

Layer 2 可做流量过滤 根据设备的MAC地址将网段分为两个分段(冲突域) 根据MAC地址形成MAC table

根据目的地址判断是否需要转发到别的段 比hub智能一些

### Switches 交换机

负责帧的识别和转发 

交换机的每个端口和网桥一样 因此交换机可以将网络分为很多冲突域

物理星形，逻辑星形 (hub是物理星形逻辑总线)

### Router 路由器

检查报文并转发

局域网通过路由器相连形成广域网 因此路由器要在广域网上找到合适的目的进行报文转发

 ![image-20210524214258564](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524214258564.png)

高层设备可以识别低层的数据格式路由器能识别帧 交换机可以接入介质

低层设备无法识别高层设备

# 2 OSI层次

## Physical 物理层

### Network Type 网络类型

通讯分为两种：多路复用&点对点

共享介质：主要通过电信号传播——不止是同轴电缆，现在基于hub和双绞线也可以实现

点对点：主要基于光缆，早期的拨号方式也是

### LAN Media 物理层介质

电信号/光信号/无线电波——功能都是传输数据

其转发过程都被成为encoding 编码

通过调幅调频来实现编码

*STP* - Shielded Twisted Pair 屏蔽双绞线

#### UTP 非屏蔽双绞线

*UTP* - Unshielded Twisted Pair 非屏蔽双绞线

两股线绞在一起，一定程度上避免电磁波干扰，相较于STP更便宜，有效范围100m

优点：易于部署/轻便，便宜

缺点：只通过双绞避免噪音，避免噪音能力不强，需要原理大功率电器、范围有限

#### Coaxial 同轴电缆

比较早的传输介质

橡胶套->绝缘膜->金属网->塑胶套 分为细缆(便宜，传输距离小)粗缆(贵，传输距离长，一般500m)

#### Fiber-Optic 光缆

一般两个接口，一个发送，一个接收，成本高

单模：

细，传输损耗小，传输距离远，一般广域网使用

多模：

粗，传输损耗大，可以同时传输多路信号，一般局域网使用

#### Wireless 无线

Lasers 激光 

Infrared

Radio

### UTP for Ethernet 

一类线：主要用于语音传输，不用于数据传输

二类线：传输频率1MHz，用于语音和最高4Mbps的数据传输，常见于令牌网 

三类线：EIA/TIA568标准指定电缆，传输频率16MHz，用于语音传输及最高传输速率为10Mbps的数据传输，主要用于10BASE-T 

四类线：传输频率为20MHz，用于语音传输和最高传输速率16Mbps的数据传输，主要用于令牌网和 10BASE-T/100BASE-T 

五类线：增加了绕线密度，外套高质量绝缘材料，用于语音和数据传输(主要为100/1000BASE-T)，是最常用的以太网电缆 

超五类线：衰减小，串扰少，具有更高的衰减/串扰比和信噪比、更小的时延误差，主要用于1000BASE-T

六类线：传输频率为1MHz～250MHz，性能远高于超五类标准，适用于高于1Gbps的应用

七类线：带宽为600MHz，可能用于今后的10G比特以太网。 

### 网线分类

#### 直通线（Straight cable）：

线的两端都是T568A或T568B

作用：主机连到交换机/交换机连到路由器

#### 反转线（Rollover Cable）：

也叫Console cable 控制台线

一端的插脚1连接另一端的插脚8；然后插脚2连接到插脚7、插脚3连接到插脚6，以此类推

用于把PC连接到交换机或者路由器 连接PC时还要加一个适配器并启用超级终端

#### 交叉线（Crossover）：

一端是T568A，另一端是T568B

可用于连接两个相同的设备，PC与路由器直连，也可用于连接两个或多个集线器或交换机

连接两个独立的工作站以创建迷你局域网

### Media and Signal Problems

Propagation 传播 -- 传播时间：由介质决定

Attenuation 衰减 -- 信号介质和周围干扰都会产生损耗

Noise 干扰

### Collision Domains冲突域

第一层不能解决冲突问题，需要对第一层进行一定的限制，在第二第三层分段

### 数据通信基本知识

#### 基本术语

信号：数据的电气或者电磁的表现

码元：在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。

#### 信号处理

模拟信号可以被分为简单信号和复合信号

​	简单信号（正弦波）不能被分解为更简单的模拟信号

​	复合信号可以被分解为多个**正弦波**

复合模拟信号的分解：**傅立叶分析**

​	任何一个周期为T的有理周期性函数 g(t)可分解为若干项    	（可能无限多项）正弦和余弦函数之和：

```Text
f = 1/T 基本频率；an,bn ：n次谐波项的正弦和余弦振幅值
```

数字信号一般是非周期性的，通常在传输介质上表现为方波

一个数字信号可以分解为无穷多个被称为谐波的简单正弦波，每个谐波都具有不同的频率与相位

在介质上发送数字信号时，其实质是在发送无穷多的简单谐波，如果某些分量未能忠实地通过介质传输，则在接收端将产生信号畸变

由于介质本身的限制，信号畸变是难以完全避免的

任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。 

码元传输的速率越高，或信号传输的距离越远，在信道的输出端的波形的失真就越严重

#### 无噪声信道的最高传输速率

 ![image-20210525153155447](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525153155447.png)

#### 噪声信道的最高传输速率

 ![image-20210525153222995](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525153222995.png)

香农公式含义

- 信道带宽或信道的信噪比越大，极限传输速率越高
- 只要信息传输速率低于信道的极限信息传输速率，就一定有办法实现无差错的传输 
- 若信道的带宽 *W* 或信噪比 *S*/*N* 没有上限（实际不可能），则其极限信息传输速率 *C* 也没有上限
- 实际能够达到的传输速率比香农极限传输速率低不少
- 请注意：对于频带宽度已确定的信道，即使信噪比不能再提高，且码元速率已达上限，也有办法提高传输速率。这就是用编码的方法让每个码元携带更多比特的信息量

### 理论基础

#### 波特率和比特率

波特率（调制速率）：信号每秒钟变化的次数

比特率：每秒钟传送的二进制位数。

波特率与比特率的关系取决于信号值与比特位的关系

例：每个信号值表示为３位，则比特率是波特率的３倍；也就是一个波包含几个比特

对于比特率为a bps的信道，发送８位所需的时间为 8/a秒，若８位为一个周期Ｔ，则一次谐波的频率是：  f = a/8 Hz

### 数据通信技术

#### 调制

把基带信号调制后进行传输  调频/调相

 ![image-20210525155601187](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525155601187.png)

#### 编码方式

##### 1. 单极性编码

0电平表示0，正电平表示1

缺点：难以分辨一位的结束和开始/发送方与接收方必须有时钟同步/若信号中01连续出现，信号直流分量将累加，容易产生传播错误

##### 2. 极化编码

###### 不归零制码 NRZ - None-Return to Zero

负电平表示0，正电平表示1

缺点：难以分辨一位的结束和开始/发送方与接收方必须有时钟同步/若信号中01连续出现，信号直流分量将累加

###### 不归零反相编码

信号电平的一次翻转代表比特1，无电平变化代表0

优于不归零电平编码，可以根据电平跃迁进行有限的同步

###### 归零编码 RZ - Return to Zero

 ![image-20210525160520885](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525160520885.png)

优点：本身带有同步信息，经济型好，不易出错

缺点：需要用三个不同电平，两次变化表示1，占用了很多带宽

###### 曼彻斯特码 Manchester

每一位中间都有一个跳变，从低到高表示0，从高到底表示1 编码率50%

 ![image-20210525160819648](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525160819648.png)

###### 差分曼彻斯特码 Differential Manchester

每一位中间跳变：表示时钟

每一位位前跳变：表示数据 （有跳变 - 0 无跳变 - 1）

​	![image-20210525161158893](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525161158893.png)



##### 3. 双极性编码

###### 双极性传号交替反转码 AMI

零电平表示0，正负电平的跃迁表示1，实现对1电平的交替反转

优点：对每次出现的1交替反转，使直流分量为0/连续的0无法同步，但连续的1可以

#### 多路复用

为了提高线路利用率，经常让多个信号共用一条物理线路

##### 时分复用 TDM Time Division Multiplexing

时分复用是将时间划分为一段段等长的时分复用帧，每个时分复用的用户在每个TDM帧中占用固定序号的时隙。

* 每个用户所占用的时隙时周期性出现的

* TDM信号也称为等时信号

* 时分复用的所有用户在不同的时间占用同样的频带宽度

 ![image-20210525163321591](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163321591.png)

时分复用的浪费：

![image-20210525163508880](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163508880.png)

##### 统计时分复用 STDM Statistic TDM

谁先来就服务谁

![image-20210525163635306](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163635306.png)

##### 频分复用 FDM Frequency Division Multiplexing

用户在分配到一定的频带后，在通信过程中一直占用这个频带

所有用户在同样的时间占用不同的带宽（频率带宽）资源

 ![image-20210525163840676](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163840676.png)

##### 波分复用 WDM Wavelength Division Multiplexing

光缆的复用，就是光的频分复用

##### 码分复用 CDM Code Division Multiplexing

码分多址 CDMA Code Division Multiple Access

对数据进行编码，各个用户使用不同码型，彼此不干扰

抗干扰能力强

## Data Link Layer 数据链路层

### 概述

第二层只在一个具体链路上，无法跨网段

#### 主要任务

* 错误识别

* 网络拓扑实现
* 流控制，帮助有效传输

#### 第一层与第二层的区别

* 物理层无法与更高层交流，而第二层有此机制，称为LLC（Logical Link Control）
* 共有链路时，物理层无法判断哪个主机可以发送/接受数据，而第二层可以决定
* 物理层无法对主机进行识别，第二层基于MAC地址可以识别
* 物理层之能发送比特流，而第二层可以用帧的形式来组织这些bit
* 物理层只能实现数据传输，无法判断数据对错，数据链路层可以根据数据格式检测并修复错误，接着把数据交给上层

#### 第二层的服务

1. 无确认，无需建立事先连接关系——只发送，不管接收和应答

   需要通讯质量，避免长期不应答引起堆积，常用于LAN

2. 有确认，无需建立事先连接关系

3. 面向连接 一般用于蓝牙连接等事先绑定

#### MAC in Common LANs 局域网介质访问控制

* Ethernet 以太网

  在物理上采用星形或拓展星形，逻辑上为总线

* Token Ring 令牌环

* FDDI 

##### Deterministic 确定性规则

连接的节点组成回路，以此获得令牌并发送/获得信息

如果令牌转了一圈没有节点使用，数据会被丢弃

当传输数据的帧结束了返回到传送主机时，主机重新发送一个令牌，释放它所占用的环

##### Non-deterministic 不确定性规则

先来先用

CSMA/CD Carrier Sense Multiple Access with Collision Detection

避免冲突

#### 局域网通讯的三种方式

1. 单播  一发一收

2. 主播  一个发送方，发给一组特定的接收方，他们有一组特定的进程接收数据

3. 广播  一个发送，向网络内所有节点发送，用于公告/表明身份/请求信息

### 以太网和CSMA/CD

数据链路层被IEEE分为两个部分：LLC and MAC 

LLC:链路服务控制

MAC:介质访问控制

 ![image-20210525201103454](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525201103454.png)

#### MAC

![image-20210525202806567](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525202806567.png)

##### Preamble 前导码

前7个字节的10101010 加10101011 告诉接收站准备开始传输数据帧了

##### Destination and Source physical address

源物理地址：一个单播地址

目的地地址：单播、主播或广播（6字节全1）地址

第二层设备基于MAC地址发送，目的地址放前面可以避免无效解析，加快传输

##### Length 长度

原来用于指定这个帧的长度

在以太网II型标准下，无需长度也能算出

Data长度不能超过1536个字节

IEEE802.3中规定，如果Length / Type的值大于0×600则表示是类型，0x600 = 1536

最小是46字节

6+6+2+46+4=64 **确保发送一次数据占满100m双绞线，不会同时发送**

##### FCS 

用来存放CRC的余数，如果发送方和接收方结果不同则数据错误

![image-20210525204122742](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525204122742.png)

#### LLC

##### 封装

LLC获得网络层的数据（packet）后，对其加入以下两个控制信息进行封装来标志上层协议，然后传递给MAC子层继续进行数据封装

目的服务可达点DSAP/源服务可达点SSAP

#### CSMA/CD

Carrier Sense Multiple Access with Collision Detection

MAC地址 - 48位 烧在网卡上 一般用十二位16进制表示

第一个bit为0—单播，1为主播

第二个bit 0 - global 1 - local 

前24个bits OUI 烧录的厂商购买的描述自己的识别码

后24个bits 每个设备独有

#### 广播地址

目的MAC地址：FFFF.FFFF.FFFF

广播使用场景：目的MAC地址不清楚/目的是全部主机

#### 组帧framing

组帧是第二层封装的过程

帧是第二层的协议数据单元

帧的部分叫做域，每个域由字节构成

#### CSMA/CD传输流程

以太网传输数据时，所有的PC都会接收数据，再根据需求考虑是否丢弃数据

JAM SIGNAL：冲突信号，32位或者更多的1，所有的设备都会接收该信号

所有设备根据回退算法回退一个时间，重新发送

![image-20210525210919107](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525210919107.png)

### 无线网和CSMA/CD

**a. IEEE 802.11**

一个关键技术：直接序列扩频Direct Sequence Spread Spectrum (DSSS) 

DSSS 适用于操作在1到2 Mbps范围内的无线设备

DSSS 可能操作高达11 Mbps 但超过2Mbps的操作是不兼容的

**WIFI从此产生**

**b. IEEE 802.11b**

也叫Wi-Fi™ 

它将传输能力提升至11 Mbps

所有802.11b系统都是向后兼容的，所以他们也支持802.11的1 到2 Mbps数据传输率

通过使用802.11一个不同的编码技术获得更高的数据吞吐率 

操作在2.4 GHz之内

**c. IEEE 802.11a**

覆盖使用5 GHz传输带宽的WLAN设备 

使用5 GHz

802.11a有能力提供54 Mbps的数据吞吐率，若是使用叫做“双倍率”的专利技术可以到达 

实际上，更标准的速率为20-26 Mbps. 

**d. IEEE 802.11g**

提供和802.11a (54Mbps)一样的吞吐率，但能向后兼容802.11b

使用正交频分多路复用技术(OFDM)技术 

**e. IEEE 802.11n：WLAN的下一代（目前主要使用的）**

提供和802.11g相比两倍的带宽108Mbps，理论上可达500-600Mbps 

### CSMA/CA 

CSMA/CA（Carrier Sense Multiple Access with Collision Avoidance）

无线网络中，发生冲突时，基站只能了解到周围的传输，做不到全部链路监听，因此CSMA/CD并不适用

两个问题：

**hidden station problem**

A -> B <- C A和C信号同时到达B 发生冲突

**exposed station problem**

A <-B C-> D   C监听到B给A的信号，为了避免冲突，不发送给D信号

发送站点在发送数据前，以控制短帧刺激接收站点发送应答短帧，使接收站点周围的站点监听到该帧，从而在一定时间内避免数据发送

 ![image-20210526190629466](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210526190629466.png)

### 第二层设备

#### NIC 网卡

**有LLC的能力** 即可以与更高层交互 对报文接收并且封装

**媒介到达控制** 向共享媒介提供结构化的通路

**命名** 提供一个独特的MAC地址标识

**帧** 封装数据的一个过程，将数据封装成bits

**信号** 通过内置传输装置产生信号并且与媒介相接

#### Bridges 网桥 

网桥将数据分成段，并根据MAC地址来筛选数据，注意，不是根据协议来筛选

通过减少大型冲突的发生，网桥可以提高网络性能 把大的冲突域变成多个小的

**在数据段很少的网络少网桥工作性能最好**  当数据段很多时，网桥就会成为一个瓶颈，降低回话速率 各个链路的带宽无法同时保障

##### 透明网桥

网桥会学习MAC table 

 ![image-20210526192423714](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210526192423714.png)

接收数据帧 接口1 能接收123 接口2 能接受456 但是动态学习 长时间不刷新就会删除掉

* **“透明”**是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的

* 透明网桥是一种即插即用设备，其标准是 IEEE 802.1D

  ​	因为是根据MAC地址来接受发送的 所以可以热插拔 MAC table就能学习好了

*  目前以太网中使用得最多的网桥

* **广播风暴**  当网络上的设备想要发送数据的时候 但是它不知道目的地址就会广播 广播时每个节点都会处理判断并处理接收的数据，会造成性能下降 所以第二层更多的使用交换机

#### Switch 交换机

##### 操作：

* 交换数据帧：从一个接口接收 到另一个端口转发

* 维持交换行为：交换机构建并维持交换表，查找循环，路由器构建并维持路由表和服务表

也可以分割冲突域

母线带宽很高 可以按逻辑分配 支持各个段的完全带宽

如果目的帧不在MAC table内 会广播

速度相较于网桥快很多 可以快速转发不做校验 保证速率

第二层的设备不能做广播域的隔离

路由器既可以屏蔽广播 也可以packet检查 根据逻辑地址转发 路由器可以做很多事 所以延时长

## Network Layer 网络层

### 网络层概述 

第二层用MAC定位主机，但全球几十亿个主机，很难全部使用MAC定位，需要新的逻辑定位主机，且逻辑需要一定的抽象性

第三层希望通过一个统一的逻辑，即路由选择算法，在逻辑上进行路径选择。该逻辑对第二层透明，因此做到了不同网段的互连

#### 第三层的责任

* 通过网络传递数据

* 使用分层的寻址方案（不同于水平的MAC寻址——第二层寻址方案）
* 网段与数据流控制
* 减少拥堵
* 与其他网段相通
* 向下屏蔽不同介质的差异

 ![](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\1.png)

### IP 地址和子网划分

 ![](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\2.png)

#### 首部

**版本** 占4bit 表示IPV4/IPV6

**首部长度** 占4bit 可表示最大15个单位（一个单位是一行四个字节） 因此IP首部长度最大值为60字节 可变部分最大长度40字节

**服务类型** 占8bit 用来后的更好的服务 以前一直没有被使用

**总长度** 占16bit 首部和数据之和的长度 单位为字节 最大65535 一般不超过1500

**标识** 占16bit 和标记/位偏移共同使用 不是为了确认 只是为了报文分配 

​	如一个无线大报文拆成两个有限小报文发出 转发后需要进行合并 这就可以根据标识号来决定

**标志** 占3bit 最高位为0 DF(don't fragment)为0时允许分配 MF(more fragment)为0表示最后一个分片

**片偏移/位偏移** 占12bit 较长的分组在分片后 某片在原分组中的相对位置 以8个字节作为偏移单位

例

分片的时候，`每个片的长度都要是8的倍数`

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\3.png" style="zoom:50%;" /><img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\4.png" style="zoom:50%;" />

 **生存时间** 占8bit TTL(Time To Live) 数据报在网络中可通过的路由器数的最大值 最大值为255

路由器每转发一次 TTL减1 到0时将报文丢弃 同时告诉源地址报文被丢弃 **可以避免网络中冗余的回路或将TTL置为1用来传给相邻的路由器**

**协议** 占8bit 指出数据报携带数据采用何种协议处理 

**首部校验和** 占16bit 与第二层循环冗余除法校验不同 这里只有两个字节 做的是反码算数求和 发送方计算完后得到的校验和会在接收端取反码 如果结果为0 则保留 否则丢弃该数据报

**源地址**和**目的地址**各占4字节

#### 网络层地址

IP地址32位长 一般写成4个字节中间用点分开的样式

一般IP地址前段是networkID，后段是HostID

networkID用来区分网段，需要Internet管理组织分配 host则不需要，由局域网的管理员分配来标识网段内特定的设备

##### IP地址分类

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\5.png" style="zoom:67%;" />

##### 主机数

不同类别的主机最大数量是不同的

A类网络中n最多有16,777,214 个主机(2^24 –2)

B类网络中最多有65,534 个主机(2^16 –2)

C类网络中最多有254个主机(2^8 –2)

每个网络中的第一个地址（即主机号全为0）是预留(reserved)的网络地址，表示本机所连接的网络地址

最后一个地址（即主机号全为1）预留的，用于广播

例：

113.0.0.0 只能用来标识网段 不能分配给主机 

176.10.255.255 广播地址

255.255.255.255 受限广播地址 适用于所有网段 但无法跨路由器转发

##### IP寻址

**私有地址空间**

**10.0.0.0       -  10.255.255.255**

**172.16.0.0   -  172.31.255.255**

**192.168.0.0 -  192.168.255.255**

有一些IP地址范围预留给私有IP地址空间 避免网络IP被耗尽

IP 地址损耗 和它的解决办法 :

​	NAT（网络地址转换Network Address Translation）

​	CIDR（无类别域间路由，Classless Inter-Domain Routing）

​	IPv6（Internet Protocol Version 6互联网协议）

#### 子网

A类网B类网主机数很多，但很难有大数量主机组成子网的情况 因此可以根据IP地址来划分多个子网并进行分配

* 子网是网络的小划分——提供寻址的灵活性

* 子网地址通常由网管分配

* 子网减少了广播域

**借位**

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\6.png" style="zoom:50%;" />

最少借两位 如果只借1位 子网取0 host取0 和网络位相同 子网取1 host取1 和广播位相同 产生混淆

最多需要给host留2位 如果只留1位 那只有网络位和广播位 不能使用

借位副产物：**地址的浪费**

 ![](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\7.png)

##### 子网掩码

将前面的网络位都写成1 后面的host位都写成0

Class A: 255.0.0.0

Class B: 255.255.0.0

Class C: 255.255.255.0

**计算子网的划分**

例 将223.14.17.0进行子网划分，使得IP拥有13个子网，每个子网有10个主机

1. 确定网络类型 -> C类网络 子网掩码：255.255.255.0

2. 需要13个subnet，每个net10个主机，借2,3,5,6都不行 只能借4位

3. 借4位，有16-2=14个子网，

4. IP最后一个字节的前4位都为1来得到子网掩码，即11110000，前28位都是1，就是240，因此子网掩码是255.255.255.240

5. 14个可用的子网，每个子网14个可用的主机

**通过子网掩码计算NetworkID**

1. 将IP和子网掩码换成二进制

2. 两个数做布尔加法

3. 得到的结果转十进制

例 IP 172.16.2.120 子网掩码 255.255.255.0

布尔加法转十进制 -> 172.16.2.0

**可以帮助主机决定目的IP地址是否和本机同一个网段 如果是 直接发送 否则先发送给网关**

路由器也会做类似的运算来决定报文发送到哪个网段

### 第三层设备

#### 路由器

主要工作：path determination 路径选择/报文转发

#### IP地址

基于逻辑地址，不像MAC是写死的，IP可以动态配置，只要传到网段就可以

整体流程 **寻找路径 -> 转发 ->报文交换**

![image-20210531001027039](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531001027039.png)

A5发给B5，数据帧目的地址是B5的IP地址，先以A1为目的地址发送到路由器，查找路由表后，从A1到B1并形成新的数据帧，目的地址是B5的MAC地址，源地址是B1的MAC地址，如果是A5的MAC地址则无法到达，无意义

#### 路由接口

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531001434574.png" alt="image-20210531001434574" style="zoom:50%;" />

一个路由器通过接口连接到网络，接口也可能指IP路由中的一个端口

每一个接口都有一个单独的、独特的网络地址

#### IP地址分配

##### 静态地址分配

​	给每一个设备配置一个IP地址

​	你应该保留非常细致的记录，因为一旦你是用的重复的IP地址，问题就来了

##### 动态地址分配

​	这里有一些可以动态分配地址的不同方法：

​		–RARP: Reverse Address Resolution Protocol.逆向地址解析协议

​		–BOOTP: BOOTstrap Protocol.自举协议

​		–DHCP: Dynamic Host Configuration Protocol.动态主机配置协议(我们一般使用这种方式)

### ARP协议 

Address Resolution Protocol 地址解析协议 根据IP地址信息获得MAC地址

ARP 使得一台电脑可以获取与一个IP地址相关的MAC地址

#### ARP操作

ARP中的ARP table类似Switch中的MAC table，可以学习

1. 广播询问MAC地址(请求) 将目的MAC设为全1 ff.ff.ff.ff
2. IP地址匹配(检查)
3. 对应主机回复自己的MAC地址(应答)
4. 根据ARP缓存表发送数据帧(ARP缓存表中每个条目具有一定的生命周期)(缓存)

**但广播不能跨网段，如果不在一个网段内怎么办？**

1. 默认网关

   为了让一个设备可以和别的网络中的设备通讯，你必须给它提供一个默认网关

   默认网关是连接来源主机所处的网段的路由接口的IP地址

   为了让一个设备可以给其它网段上的设备发送数据，来源设备将数据发送到默认网关

2. 代理ARP

   代理ARP是ARP的一种变化形式 

   这种情况下，来源主机没有配置默认网关 

   如果ARP请求发现目的地址不在本网段，就把本网段连接路由器的端口返回

   到路由器另一个端口时广播找目的地址

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531003045883.png" alt="image-20210531003045883" style="zoom:50%;" />

**ARP攻击**

利用ARP缓存机制，一直写死，这样就无法上网

### 网络层服务

#### 面向连接的网络服务

传输数据前会在发送者和接受者之间建立连接，代价高，但可靠

#### 虚电路交换

强于面向连接，所有报文按顺序在连接的虚电路上传输，整个虚电路无法复用，效率低，但不用路径选择

#### 无连接

发送方直接向目的方传输，适用于突发性传输，可能丢失

#### 报文交换

原始数据分为很多子报文，每个子报文各自发送

### Routed and Routing Protocols

Routed Protocols用在路由器之间，做转发的判断，从而使得路由器能够有效连通，基于第三层

Routing Protocols用在路由器之间，不负责转发，做的是动态路由表的生成，基于路由表来做Routed Protocols

#### 分类

##### 静态 & 动态

静态路由:

​	网关手动将路由信息输入路由器 

动态路由:

​	路由器可以联机（on the fly）交换彼此信息

​	使用路由（routing）协议来更新路由信息

​	RIP, IGRP, EIGRP, OSPF …

**静态路由VS动态路由**

静态路由:

​	隐藏了部分互联网

​	测试网络中某个特定的链接

​	当只有一条路径到达目的网络时，便于维持路由表

动态路由:

​	维持路由表

​	定时更新路由信息

​	基于路由（routing）协议，共享路由信息

​	路由器可以适应变化的网络条件 

##### IGP & EGP

动态路由

**I**nterior **G**ateway **P**rotocols (RIP, IGRP, EIGRP, OSPF)内部网关协议: 

自治系统中的协议，管理局域网中的路由器，如：校园网，公司内网……

**E**xterior **G**ateway **P**rotocols (EGP, BGP)外部网关协议:

用于自治系统之间传送包

##### DVP & LSP

**D**istance-**V**ector **P**rotocols (RIP, IGRP)距离矢量协议:

​	从相邻的视角看网络拓扑

​	路由器之间添加距离矢量

​	周期性频繁的更新

​	复制一份路由表，传给相邻路由器

**L**ink **S**tate **P**rotocols (OSPF)链路状态协议:

​	了解整个网络拓扑

​	计算去其它路由的最短路径

​	**由事件触发更新**

​	把链路状态路由的更新信息发给其它路由

#### RIP(Route Information Protocol)路由信息协议

最受欢迎

属于内部网关协议、距离矢量协议

跳数hop是唯一的度量标准，短板，评判依据简单

最大跳数为15

每30秒更新一次

不总是选择最快路径，选择跳数最少的路径

产生很多网络拥塞

RIP v2 是 RIP v1的一个很重要的改进版本

#### IGRP(内部网关路由选择协议)&EIGRP(增强网关路由选择协议)

思科专利

属于内部网关协议、距离矢量协议

综合以延迟，带宽，负载，可靠性为度量标准

最大跳数为255

每90秒更新一次

EIGRP 是 IGRP的进阶版, 混合了路由（routing）协议

#### OSPF(Open Shortest Path First)开放最短路径优先

标准的lsp 主要基于带宽 内存CPU消耗比DV高

属于内部网关协议、链路状态协议

综合以代价，速度，可靠性，安全性为衡量

由事件触发更新

### VLSM Variable Length Subnet Mask 可变长子网掩码

**有类路由**

​	有类路由协议要求一个网络只能有一个子网掩码

​	示例：网络192.168.187.0必须只使用一个子网掩码如255.255.255.0

**VLSM-可变长子网掩码**

​	VLSM的优点是允许一个自治系统有不同的子网掩码

有了VLSM，网管可以在少量主机的网络上使用长子网掩码，大量主机的网络上使用短子网掩码

如果路由协议允许VLSM：

​	在网络连接上使用一个30位的子网掩码，255.255.255.252

​	给用户网络一个24位的掩码，255.255.255.0

​	或者，甚至一个22位的掩码，255.255.252.0，给有着近1000用户的网络

优点:

​	更有效的使用IP地址 

​	使用路由汇总的能力更强

支持 VLSM 的路由协议:

​	OSPF开放最短路径优先

​	Integrated Intermediate System to Intermediate System (Integrated IS-IS) 

​	EIGRP增强内部网关路由选择协议

​	RIP v2 

​	静态路由

空间浪费：

​	过去建议不要使用第一个和最后一个子网，但是我们可以在Cisco IOS ver12.0中使用子网

​	在 IOS ver12.0 中, 思科路由器默认使用子网0  

​	命令：router(config)#no ip subnet-zero 

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115310841.png" alt="image-20210531115310841" style="zoom:50%;" />

一个C类地址192.168.10.0/24 (表示前24位为网络号)已经被分配

​	珀斯，悉尼，新加坡有一个连接到KL的广域网

​	珀斯需要60个主机

​	KL 需要28个主机.

​	悉尼和新加坡各需要12个主机

为了计算VLSM子网和各自的主机数，在地址范围中先分配最大的需求。需求水平应该按照从大到小的顺序排列。

**步骤一**

珀斯需要60个主机

用6位，因为这样有2^6-2=62个可用主机地址，因此第4个八位中的2位将表示/26的扩展网络前缀，剩余的6位用来表示主机地址

将VLSM用在地址192.168.10.0/24上，有：

​	192.168.10.00 hhhhhh/26

​	255.255.255.192(1100 0000)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115727941.png" alt="image-20210531115727941" style="zoom:50%;" />

**步骤二**

KL需要28个主机。在192.168.10.63/26后，下一个可用的地址是192.168.10.64/26

因为需要28个主机，所以需要5位表示主机地址，这样有2^5-2=30个可用的主机

因此需要5位来表示主机，3位用于/27的扩展网络前缀

将VLSM使用在192.168.10.64/26上，有：

​	192.168.10.**010** hhhhh/27

​	255.255.255.224(1110 0000)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115749759.png" alt="image-20210531115749759" style="zoom:50%;" />

**步骤三**

现在悉尼和新加坡各需要12个主机，下一个可用地址从192.168.10.96/27开始

因为需要12个主机，所以需要4位表示主机地址，有2^4-2=14个可用地址

因此4位代表主机，4位用于/28的扩展网络前缀

将VLSM用在192.168.10.96/27上，有：

​	192.168.10.**0110** hhhh/28

​	255.255.255.240(1111 0000)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115801671.png" alt="image-20210531115801671" style="zoom:50%;" />

**步骤四**

现在给广域网分配链接地址，记住，每个广域网链接需要2个IP地址，下个可获取的子网是192.168.10.128/28

因为每个广域网链接需要2个网络地址，所以2位用于表示主机，有2^2-2=2个可用地址

因此需要2位表示链接，6位表示/30的扩展网络前缀

将VLSM用在192.168.10.128/28上，有：

​	192.168.10.**100000** hh/30

​	255.255.255.250(1111 1100)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115820879.png" alt="image-20210531115820879" style="zoom:50%;" />

**result**

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115834900.png" alt="image-20210531115834900" style="zoom:50%;" />

只有没有被使用的子网可以被进一步划分子网

如果一个子网的任何地址被使用了，那么这个子网不能再被划分

### 路由聚集 Route Aggregation

无类别域间路由和VLSM的使用，不仅防止了地址浪费，还促进路由聚合 

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120056154.png" alt="image-20210531120056154" style="zoom:50%;" />

**示例**

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120216315.png" alt="image-20210531120216315" style="zoom:50%;" /> 

**计算**

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120244620.png" alt="image-20210531120244620" style="zoom:67%;" /> 

**优点**

​	减少路由表条目数

​	用于隔离拓扑的变化

**注意**

​	为了让聚合正确工作，要仔细地在层次结构中分配地址，使得汇总的地址分享同样的高位比特 

​	VLSM 允许路由聚合，通过将聚合完全基于左边共享的高位，来增加灵活性，即使网络是不连续的。

### ICMP

ICMP (Internet Control Message Protocol)：为了提高 IP 数据报交付成功的机会

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告

ICMP 只是 IP 层的协议

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去

#### ICMP报文格式

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120909893.png" alt="image-20210531120909893" style="zoom:50%;" />

#### 两种ICMP报文

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531121023870.png" alt="image-20210531121023870" style="zoom:50%;" />

#### 目的站不可到达

**网络不可到达**(net unreachable)

**主机不可到达**(host unreachable)

**协议不可到达（**protocol unreachable）

**端口不可到达（**port unreachable）

**源路由选择不能完成（**source route failed）

**目的网络不可知（**unknown destination network）

**目的主机不可知**（unknown destination host）

#### ICMP差错报告报文的数据字段的内容

![image-20210531121139610](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531121139610.png)

#### 不应发送ICMP差错报告报文的几种情况

* 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文

* 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文

* 对具有多播地址的数据报都不发送 ICMP 差错报告报文

* 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送 ICMP 差错报告报文

#### PING(Packet InterNet Groper)

PING 是用ICMP的"Echo request"和"Echo reply"消息来实现的

PING 用来测试两个主机之间的连通性

PING 使用了 ICMP 回送请求与回送回答报文

PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP或UDP

## Transport Layer 传输层

### 第四层概述

#### 功能

将上层给的数据分成新的数据单元

建立终端到终端的操作

将段从一台主机发送到其他主机

流量控制和可靠性

​	第二层第三层不负责数据可靠性校验 出错就丢失

​	flow control 类比与外国人说话 重说/说慢 -> 主机性能不同

#### 两个重要的协议

将上层给的信息分成数据段，放入packet中发送 接收方还原信息

Transmission Control Protocol (TCP) 传输控制协议->可靠

* connection-oriented 面向连接

* 软件的段检查

* 如果有丢失或者错误，重新发送

* 使用acknowledgment/确认应答对方 保证数据可靠

* 提供流量控制

User Datagram Protocol (UDP) 用户数据报协议->不可靠

* 无连接

* 不提供软件检查段 出错就丢弃数据

* 不使用确认 减少资源消耗

* 不提供流操作

#### 服务类型

 ![image-20210602144348436](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602144348436.png)

TCP/UDP都负责进程间通讯的管理

怎样做到第一个主机传输多个进程数据？

TCP 和 UDP 都用端口来跟踪同一时间穿过网络的不同通讯

小于255的端口号保留给TCP 和 UDP 公共应用

256-1023：公共端口  1024-49151：注册端口/登记使用  49152-65535：客户端进程随机使用 本地有意义

#### Socket 套接字

套接字表示为（IP地址：端口号） 

每一个连接表示为(套接字来源, 套接字目的), 这是一个点对点的全双工信道

TCP 不支持多播和广播

### TCP Transmission Control Protocol 传输控制协议

#### TCP要做到的

* 可靠传输

* 流控制
* 连接管理
  * 建立连接：三次握手
  * 断开连接：四次握手

#### TCP数据段结构

![image-20210602145216479](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602145216479.png)

**源端口和目的端口**

​	各占2字节

​	端口是运输层与应用层的服务接口

​	运输层的复用和分用功能都要通过端口才能实现

**序号**

​	占4字节

​	TCP传送的数据流中的每一个字节都编上一个序号

​	序号字段的值指本报文所发送的数据的每一个字节的序号

​	序号共32位 因此传输最大容量为4G

例 传输100个字节 第一个字节编号301 最后一个字节编号400

**确认号**

​	占4字节，是期望受到对方的下一个报文段的数据的第一个字节的序号

例 A->B  B的确认号为701 则A知道B已经接受了序号为700的报文

**数据偏移**

​	数据偏移(即首部长度)--占4位

​	指出 TCP 报文段的数据起始处距TCP 报文段的起始处的长度

​	单位是 32 位字（以 4 字节为计算单位）

**保留**

​	保留字段--占6位，保留为今后使用，目前置为0

**URG**

​	正常为0 当紧急URG=1时，表明紧急指针字段有效

​	告诉系统此报文字段中有紧急数据，应尽快传送(相当于高优先级的数据)

**ACK**

​	ACK=1时确认号字段有效 大部分情况

​	ACK=0时确认号字段无效 初始建立连接关系

**PSH**

​	TCP收到应用的数据并不会立刻传输 收到对方的数据也不会立刻推给应用进程 放入缓存一起发送

​	推送PSH(PuSH)—— 接收TCP收到PSH= 1 的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付

**RST**

​	复位 RST(ReSeT= 1 时，表明TCP连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接

​	握手时如果请求方发送请求而接收方拒绝则将RST置为1

**SYN**

​	同步 SYN=1表示这是一个连接请求或连接接受报文

**FIN**

​	终止 FIN(FINis)—— 用来释放一个连接。FIN= 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接

**窗口**

​	窗口字段--占2字节，用来让对方设置发送窗口的依据，单位为字节

​	发送数据段后 接受方设置 告诉发送方能发多少数据过来

**校验和**

​	占2字节，检验和字段检验的范围包括首部和数据这两部分 传输过程不会修改

**紧急指针**

​	紧急指针字段——占16位，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面） 因此紧急数据最多2^16字节

**选项**

​	初始协商时 根据网络情况确认

​	TCP 最初只有一种选项，即最大报文段长度 MSS(Maximum Segment Size)

​	MSS 告诉对方缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节

​	数据字段加上 TCP 首部才等于整个的 TCP 报文段 

​	如MSS = 536 则可以发送的报文总长为556

**填充字段**

​	这是为了使整个首部长度是4字节的整数倍

#### TCP协议

主机用段交换数据 (TPDU)

每个段有: 

​	20字节的首部 (不包括可选部分) 

​	更多数据字节

段的大小必须和IP 包匹配，也必须满足底层的需求

​	如，以太网的MTU(Maximal Transfer Unit最大传输单元) 是1500 字节

每个字节有一个32位的序号

#### 建立连接

two-army problem 

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602151434167.png" alt="image-20210602151434167" style="zoom:50%;" /> 

如果蓝军不联合则无法击败白军 而蓝军的情报有可能会被白军截获

B1发送情报需要收到B2的确认 但即使B1收到了B2的确认 B1无法确定B2知道B1确认了

**三次握手**

client端--客户端 和 server端--服务器

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602152754406.png" alt="image-20210602152754406" style="zoom:67%;" />

1. server端被动启动，开启持续listen

2. **握手1 **客户端发送连接请求，TCP数据段中将SYN置为1，ACK为0

3. **握手2 **server端收到请求后处理 看是否同意连接 

   3.1 拒绝则回答一个TCP RST = 1

   3.2 接受则应答TCP SYN = 1 ACK = 1

   3.3 进程已存在 决定拒绝或接受请求

4. **握手3 **客户端收到应答 发送一个TCP SYN = 0  ACK = 1来确认连接

5. 服务器收到确认，通知上层应用

6. 双方连接建立，client端发送请求数据

**这里虽然无法确定服务端会收到 但一般认为三次握手就是可靠的**

例![image-20210602153127643](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602153127643.png)

#### 数据传输

TCP面向连接 因此需要信道可控，且连接双方发送速率匹配

##### 停止等待协议

**注意点**

* 一端发送数据后，接受确认前可能需要重发数据，因此需要缓存

* 需要确认哪些数据收到，哪些需要重发

* **应答计时器** 当应答超过重发时间（重发时间一定大于平均运输时间的两倍）

停止等待协议是一个简单的协议，但没什么效率

##### 确认丢失和确认迟到

* A和B建立连接 当B超时未应答A 默认确认丢失 重新发送数据

* 当B收到原数据，应答还未到达A，又收到A的重发数据，B依然应答

  A收到两个应答会抛弃第二个，什么也不做

#### 可靠的通讯

##### ARQ Automatic Repeat reQuest 自定重新发送请求

重新发送的请求是自动发送的，接受者不需要请求重新发送错误的信息

##### Contiguous ARQ Protocol

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602154816128.png" alt="image-20210602154816128" style="zoom:50%;" />

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602154853548.png" alt="image-20210602154853548" style="zoom:50%;" />

发送端要发送900字节长的数据，划分为9个100字节长的报文段，而发送窗口确定为500字节

发送端只要收到了对方的确认，发送窗口就可前移

发送TCP要维护一个指针，每发送一个报文段，指针就向前移动一个报文段的距离

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602154948559.png" alt="image-20210602154948559" style="zoom:50%;" />

发送端已发送了400字节的数据，但只收到对前200字节数据的确认，同时窗口大小不变

现在发送端还可以发送300字节

**例**

|                 主机A                  |                 主机B                  |
| :------------------------------------: | :------------------------------------: |
|                 SEQ=1                  |          A现在还能发送300字节          |
|                SEQ=101                 |          A现在还能发送200字节          |
|                SEQ=201                 |              此时发生丢失              |
|    允许A再发送300字节(序号201至500)    |            ACK=201，WIN=300            |
|                SEQ=301                 |     A还能发送200字节(序号301至500)     |
|                SEQ=401                 |     A还能发送100字节(序号401至500)     |
|                SEQ=201                 | A超时重发，但不能发送序号500以后的数据 |
|    允许A再发送100字节(序号501至600)    |            ACK=501,WIN=100             |
|                SEQ=501                 |    A已把发送窗口用完(序号501至600)     |
| 不允许A再发送(到序号600的数据都已收到) |             ACK=601,WIN=0              |

#### 释放连接

![image-20210602160938518](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602160938518.png)

在A断开后，B可能还有数据要发送给A，Passive Close

1. A主动断开连接，发送FIN = 1的报文，进入FIN-1状态
2. B应答，进入close-wait状态
3. A收到应答，进入FIN-2状态，应答给B
4. B收到应答，closed，同时A等2MSL，没收到B的应答后进入closed

#### TCP的有限状态机

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602162336177.png" alt="image-20210602162336177" style="zoom:67%;" />

### UDP User Datagram Protocol

**为什么需要UDP**

* 不需要建立连接(建立连接会增加时间延迟)

* 简单: 尽最大努力交付

* 面向报文，首部开销小

* 没有拥塞控制: UDP 可以尽可能快的传输，无视拥堵

**UDP特点**

无连接:

​	UDP的发送方和接收方不需要握手

​	每个UDP段独立处理

通常被用于流多媒体应用

​	容忍包丢失

​	对速率敏感

UDP 使用于:

​	RIP: 为了周期性发送路由信息

​	DNS:避免开始TCP连接时的延迟

​	SNMP: 当堵塞时，SNMP必须仍然可运行。没有拥堵和可靠的控制机制时，UDP比TCP表现得更好 

​	其它协议包括TFTP, DHCP 

如果必要，给应用层增加可靠性

**UDP格式**

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602163410765.png" alt="image-20210602163410765" style="zoom:50%;" />

### NAT and PAT

NAT Network Address Translation   可以让局域网的Private网段访问Internet

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602163829985.png" alt="image-20210602163829985" style="zoom:50%;" />

静态 NAT:

​	将内部网络的私有IP地址转换为公有IP地址，IP地址对是一对一的，是一成不变的

动态 NAT:

​	通过地址池进行映射，基于先到先服务动态完成，用完了则后面的地址无法上网

##### NAT地址划分

**Inside Local address (内部本地地址** ):内网IP地址

**Inside Global address (内部全局地址):** 注册IP地址,对外部展示的内部地址

**Outside Global address (外部全局地址)**:由主机所有者分配的IP地址。通常是注册地址

![image-20210602164622182](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602164622182.png)

##### NAT的优点和缺点

优点：因为不是每一个内部主机都需要同一时间访问外部，你可以用一小部分全局独一无二的地址来服务相对大量的私有地址的主机

缺点：一对一映射

如果私有地址空间是a/8，但是公共地址是a/24，同时只能有254台主机访问因特网

#### PAT

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602164932482.png" alt="image-20210602164932482" style="zoom:50%;" /><img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210602164950090.png" alt="image-20210602164950090" style="zoom:50%;" />

## Application Layer

### The Session Layer 会话层

#### 会话层功能

提供了丰富的用户对数据的控制和管理

建立，维护和终止应用间的会话

- 包括开始，停止和重新同步两台主机间的临时会话(rap session)

#### 检查点

检查点用于分离部分会话，过去被称为对话

对话分离是有序地初始化、终止和通讯控制

#### 第五层的一些应用

- NFS: Network File System，网络文件系统
- SQL: Structured Query Language，结构化查询语言
- RPC: Remote Procedure Call，远程过程调用
- X Window System，X视窗系统
- ASP: AppleTalk Session Protocol，AppleTalk会话协议
- SCP: DNA Session Control Protocol，DNA(Digital Network Architecture，数字网络架构) 会话控制协议

### The Presentation Layer 表示层

屏蔽不同格式数据的影响，进行统一 如ASCII和EBCDIC编码

负责将数据表示成接受设备可以理解的格式，有以下三个主要功能

- 数据格式化

  如编码转换，图片格式，多媒体格式

- 数据压缩

- 数据加密

### The Application Layer 应用层

对应交互界面

- 应用层(最接近用户) 支持应用的通讯部分 
- 应用层： 
  - 识别并建立有意通讯双方的可用性
  - 同步化合作应用
  - 建立错误修复流程的协议
  - 控制数据完整

#### 如何使用

- 通过使用网络应用（如：www, e-mail, ftp, telnet远程登录），提供一个直接接口给OSI模型的剩余部分
- §或者通过使用独立应用程序（如：word processors文字处理软件,spreadsheets电子表格,presentation managers绘图,network redirector网络转发程序），提供一个不直接的接口

#### HTTP

- HTTP 是面向事务的客户服务器协议。

- HTTP 1.0 协议是无状态的(stateless)。

- HTTP 协议本身也是无连接的，虽然它使用了面向连接的 TCP 向上提供的服务。

- 万维网浏览器就是一个 HTTP 客户，而在万维网服务器等待 HTTP 请求的进程常称为 HTTP daemon，有的文献将它缩写为 HTTPD。

- HTTP daemon 在收到 HTTP 客户的请求后，把所需的文件返回给 HTTP 客户。  

- HTTP的报文结构(请求报文)

  - 报文由三个部分组成，即开始行、首部行和实体主体；在请求报文中，开始行就是请求行

  - | 方法（操作） | 意义                            |
    | ------------ | ------------------------------- |
    | OPTION       | 请求一些选项的信息              |
    | GET          | 请求读取由URL所标志的信息       |
    | HEAD         | 请求读取由URL所标志的信息的首部 |
    | POST         | 给服务器添加信息（例如，注释）  |
    | PUT          | 在指明的URL下存储一个文档       |
    | DELETE       | 删除指明的URL所标志的资源       |
    | TRACE        | 用来进行环回测试的请求报文      |
    | CONNECT      | 用于代理服务器                  |

  - 上表为HTTP请求报文的一些方法

#### HTML

- 定义了许多用于排版的命令（标签）。
- HTML 文档是一种可以用任何文本编辑器创建的 ASCII 码文件。 
- 仅当 HTML 文档是以.html 或 .htm 为后缀时，浏览器才对此 文档的各种标签进行解释。
- 当浏览器从服务器读取 HTML 文档，针对HTML 文档中的各种标签，根据浏览器所使用的显示器的尺寸和分辨率大小，重新进行排版并恢复出所读取的页面。
- HTML 用一对标签（一个开始标签和一个结束标签）或几对标签来标识一个元素。

#### FTP和TFTP

- FTP 是**使用TCP**来传输文件的，可靠的，面向连接的服务
  - FTP 首先建立一个客户端和服务器之间的控制连接(端口 21)
  - 然后建立第二个连接，连接数据传输要经过的电脑 (端口20)
- TFTP 是**使用UDP**的，不需要连接的服务
  - 小且容易实施
  - 如，TFTP用于路由器来传输配置文件和思科IOS 镜像 

#### Telnet远程登录

Telnet客户端软件提供了登录正在运行Telnet服务器应用的远程网络主机的能力，然后执行命令行的命令

不同的系统，不同的指令集有差异，要在本地将指令标准化到服务器上才能执行

#### SMTP和POP

Simple Mail Transfer Protocol 简单邮件传输协议 传输系统之间的邮件信息

Post Office Protocol 邮局协议 用于电子邮件的接收

- E-mail服务器通过SMTP发送邮件，POP接收邮件，来交互
  - SMTP (Simple Mail Transfer Protocol)简单邮件传输协议
  - POP3 (Post Office Protocol version 3)第三版电子邮局协议
- SMTP只能传ASCII文件

MIME (Multipurpose Internet Mail Extensions) 多用途互联网邮件扩展类型

- MIME增加的5个新的邮件首部
  - MIME-Version: 标志 MIME 的版本。现在的版本号是 1.0 若无此行，则为英文
  - Content-Description: 这是可读字符串，说明此邮件主体是否是图像、音频或视
  - Content-Id: 邮件的惟一标识符
  - Content-Transfer-Encoding: 在传送时邮件的主体是如何编码的
  - Content-Type:说明邮件主体的数据类型和子类型

#### 内容传送编码

- 最简单的编码就是 7 位 ASCII 码，而每行不能超过 1000 个字符。MIME 对这种由 ASCII 码构成的邮件主体不进行任何转换
- 另一种编码称为 quoted-printable，这种编码方法适用于当所传送的数据中只有少量的非 ASCII 码
- 对于任意的二进制文件，可用 base64 编码

#### SNMP

简单网络管理协议是一个用于在网络设备之间管理信息交换的应用层协议 

#### DNS

![image-20210603005814214](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210603005814214.png)

Domain Name System 域名系统

- 域名服务器系统建立于一个分层结构，创建了不同等级的DNS服务器
- 每一层的DNS服务器判断它本身能否把域名翻译成相对应的IP地址：
  - 如果它可以这么做，它就翻译，并把结果返回给客户端
  - 如果不可以，它就向更高层发送请求

![image-20210603010032088](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210603010032088.png)

#### 应用层：通讯方式

- 通讯处理发生的一种途径：
  - 当打开一个浏览器，它连接到了默认页面，这一页的文件被传送到了客户机  
  - 当该流程结束后，连接断开
- 第二种途径:
  - 像Telnet和FTP, 建立连接到服务器，并保持连接直到所有流程被执行 
  - 当用户觉得他已经结束了，客户端断开连接 
- 所有通讯活动都可以归纳到这两种分类之一 

#### DHCP

##### 工作原理

​	TCP/IP使用前需要进行具体的IP配置：IP地址，子网掩码，默认路由器的IP地址... 很麻烦

​	Dynamic Host Configuration Protocol可以在局域网内就高效地分配IP地址——局域网协议，基于UDP

​	DHCP-client给网段内的DHCP-server广播一个Discover报文，server端收到后发送一个报文给client，client端再给server端Request报	文

​	**发现阶段** client不知道server是谁，广播一个带有自己MAC地址的报文给server，server端记录地址池

​	**相应阶段** server根据自己的可用情况发送一个IP地址，子网掩码，默认路由器的IP地址等的报文给client

​	**选择阶段** 主机选择接受哪一个，然后广播Request，让所有的server能够同步

​	**租约确认阶段** server接收到request后，以DHCP ACK消息向Client确认。出错则广播否定确定消息DHCP NAK

​	**租期续约** client发送request请求续租

​	**租期释放** 用完了发送一个Release报文(不常用，一般是client直接关闭，server自动回收)

##### DHCP报文结构和报文类型

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210605200317872.png" alt="image-20210605200317872" style="zoom:50%;" /><img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210605200339175.png" alt="image-20210605200339175" style="zoom: 67%;" />

##### DHCP欺骗原理

为了效率，client广播时，只接收第一个到达的服务器提供的网络配置参数

非授权的DHCP服务器先应答，client则被欺骗，则client出网的报文会被截获

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210605200729749.png" alt="image-20210605200729749" style="zoom:67%;" />

对A来说，上网正常，但对B是透明的

**防范**

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210605200848820.png" alt="image-20210605200848820" style="zoom:67%;" />

