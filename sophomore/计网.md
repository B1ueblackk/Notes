# 1 计算机网络概述

## 什么是网络

网络是一个连接了物体、设备、人的复杂系统、

相较于电信网/电视网，计算机网络共享的资源由终端计算机处理，可以共享多种资源 

## Data Networks Classifications 数据网络分类

### LAN(Local Area Networks)

* 一般通过广播方式通讯

- 本地运作 (覆盖区域小)
- 多用户通道
- 高速率需求 (高达10Gbps)
- 错误率可以轻松控制

### WAN(Wide Area Networks)

* 一般通过点对点方式通信

- 在大范围运作
- 通过串行链路、光链路连接
- 通常速度慢
- 错误率不好控制

### 局域网设备

hub 在第一层将设备连接起来 多端口中继器

bridge 网桥 基于MAC地址将局域网分段 第二层

switch 多端口网桥 全带宽 第二层

router 路由器 ip地址划分进行路径选择 报文转发 第三层

### 广域网设备

router 路径选择 报文转发

modem 调制解调器 CSU通道服务单元/DSU数据服务单元 模拟转为数字 远程LAN链接 

### 局域网服务和广域网服务

LAN：以太网，最受欢迎

WAN：种类多

### Internet

商业化后 用户通过ISP(Internet service provider)接入Internet 

ISP层次不同 

主机A->本地ISP->第二层ISP->NAP->第一层ISP->NAP->第二层ISP->本地ISP->主机B

![image-20210524102100993](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524102100993.png)

## Data

数据通过01序列传输，但不是01本身，需要解码

### Data Packets

为了使传输双方理解数据，规范传输标准，对不同的传输层次设置不同的数据格式

OSI参考模型中：网络层-packets 数据链路层-frames 数据段层-segments

好处：

计算机系统为分时操作系统 分成报文可以同时处理多个

某个报文丢失，重新传输丢失的一小块即可，保证效率

每个报文可以独立传输，可以选择当前最优路径

### Protocol 协议

为传输计算机网络通讯进行保障 和终端操作系统无关 不同系统可以通过相同的协议进行通信

类似于语言 语法就是协议的数据结构 语用/俗语 相当于协议中的上下文处理关系 

数据传输规则 报文中内容可以不同

### Source and Destination 源和目的

很多时候 通讯都是随机的 通讯时一般都是弱联系 没有打好招呼

目的告诉传输者报文发送到哪里 源告诉传输者报文哪里来的 多用于重新传输

### Media Types 传输介质

电：同轴电缆 粗缆 细缆 双绞线 UTP-非屏蔽双绞线 

光：光缆 速率快 不像电流 更加稳定

空气：无限传输 无需介质

### Digital Bandwidth 带宽

传输能力的度量-传输上限

单位bps bits为传输单位 传输时将字节转为位再计算带宽

### Throughput 通量

通量为实际网络传输量 因此 通量<=带宽

## Open System Interconnection Model OSI参考模型

 开放性系统互连参考标准

从一个发送点到达另一个终端  分层后 每个层次进行特定的任务

OSI把网络分为7层

1. 物理层 Physical：二进制传输

   keywords：信号&介质

   定义了传输介质，传输规格：信号等级/传输速率/信号规格 

   不做管理和控制

2. 数据链路层 Data Link：介质访问

   keywords：帧&MAC 介质访问控制

   基于帧的格式判断传输的数据是否正确并做相应的控制

   如果服务于多个用户，还要管理介质访问，避免冲突

3. 网络层 Networks：路径选择

   keywords：路径选择，基于ip地址设备联通

   跨距离远 地理上分隔开的连接

4. 传输层 Transport：终端与终端的通讯

   keywords：可靠性，流控制，错误修改

   网络系统同时收到不同报文 要发送给不同终端

   把数据分成段 并且转为数据流 传输完判断 确定数据正确再传给上层

5. 会话层 Session：进程间通讯时用户的交流

   keywords：会话

   在双方通讯时设置checkpoint确认双方是否同步以及进程控制

6. 表示层 Presentation：通讯时表示格式标准

   keywords ：Common Format 

   数据格式

7. 应用层 Application：给用户交互接口

   keywords： Browser 用户界面

好处：减少网络复杂程度/更标准化/根据层次确定产品定位 实现网络工程化 

Application Layers 应用层次：5/6/7

用户程序涉及的部分

Data Flow Layers 数据流层：1/2/3/4

网络通讯由这四层负责

OSI分层中的协议

 ![image-20210524112215333](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524112215333.png)

### Data Encapsulation 数据封装

 ![image-20210524112539119](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524112539119.png)

### Peer to Peer Communications

 ![image-20210524115216395](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524115216395.png)

## TCP/IP Model 参考模型

TCP/IP只有4层

 ![image-20210524115322525](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524115322525.png)

应用层对应OSI 5/6/7三层 对应软件相关事宜：界面处理、标准化等

传输层对应OSI 4 实现数据传输 详见OSI-4

Internet Layer 对应OSI-3 负责联通、连接和传输报文 并不要求可靠性

Network Access Layer 网络接入层 也叫 host-to-network Layer 对应OSI-1&2 

### TCP/IP 相关协议

 ![image-20210524193111141](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524193111141.png)

向上能兼容应用，向下能兼容介质

*FTP* - File Transfer Protocol 文件传输协议

*HTTP* -  Hypertext Transfer Protocol 超文本传输协议

*SMTP* - Simple Mail Transfer protocol 简单邮件传输协议 (主要对应发送

*DNS* - Domain Name System 域名解析系统

*TFTP* - Trivial File Transfer Protocol 简单文件传输协议

## Network Topology 网络拓扑

定义了网络的结构

物理层面：把node具体的连接起来--介质的具体分布

逻辑层面：定义了介质的访问控制--介质如何被host访问

### Bus 总线型

 ![image-20210524194142311](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524194142311.png)

每个host都共享总线

物理层面：

​	优点：连接方便，成本低

​	缺点：总线出现折损，整个线路都无法使用

逻辑层面：

​	每个节点都能获取总线信号，如果多个节点同时向总线发送信号则会出现冲突

### Ring 环形

 ![image-20210524194536452](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524194536452.png)

物理层面：

​	所有设备都直接通过环彼此相连 -- daisy-chain

逻辑层面：

​	为了避免冲突，不允许同时使用 -- 令牌环 拿到令牌有一个时间窗口来访问介质

### Dual Ring 双环

有两个环同时接入，也需要令牌，内环只是备用，当外环损坏就切换到内环

物理层面：

​	更可靠可行

逻辑层面：

​	双环类似两个独立的环，但这两个环同一时间只使用一个

### Star 星形

 ![image-20210524195143403](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524195143403.png)



有一个中间节点将其他节点连接起来

物理层面：

​	优点：所有其他节点通讯都可以通过中心节点转发，无需经过其他节点，使得通讯更加安全

​	缺点：中心节点负担大，性能需要加强，如果中心节点瘫痪则无法使用

逻辑层面：

​	所有信息的流都会经过中心节点

### Tree 树/层次结构

越往下视野越小，适用于有逻辑层次划分的节点

物理层面：

​	树干（trunk）是拥有多层分支的线

逻辑层面：

​	信息流是分层的

### Complete/Mesh 渔网形

物理层面：	

​	任意两节点都相连

​	优点：最大的连通性和可靠性

​	缺点：花费大

逻辑层面：

​	拓扑的性能极依赖于所使用的设备

Cellular 蜂窝形

物理层面：

​	蜂窝拓扑使用与无线网络技术，一般来说比较低效，需要相当的算法设计

## Network Devices

设备可以分为两大类

* 边缘节点 -- 终端设备：主机、打印机等

  一般工作层次比较复杂，功能齐全

* 中间节点 -- 中间设备：路由器、交换机等

### NICs Net Interface Controller 网卡 

第二层的设备

每个网卡都有一个MAC地址，是固定的

串行并行转换

 ![image-20210524213010037](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524213010037.png)

终端设备和中间设备都需要网卡

### Media 介质

Layer 1 电信号/光信号进行传输

### Repeater 中继器

Layer 1 连接两个端口 信号的识别放大 延长介质

### Hub 集线器

Layer 1 连接多个端口 Multiple Repeater

逻辑上使用总线方式连接

### Bridges 网桥

Layer 2 可做流量过滤 根据设备的MAC地址将网段分为两个分段(冲突域) 根据MAC地址形成MAC table

根据目的地址判断是否需要转发到别的段 比hub智能一些

### Switches 交换机

负责帧的识别和转发 

交换机的每个端口和网桥一样 因此交换机可以将网络分为很多冲突域

物理星形，逻辑星形 (hub是物理星形逻辑总线)

### Router 路由器

检查报文并转发

局域网通过路由器相连形成广域网 因此路由器要在广域网上找到合适的目的进行报文转发

 ![image-20210524214258564](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210524214258564.png)

高层设备可以识别低层的数据格式路由器能识别帧 交换机可以接入介质

低层设备无法识别高层设备

# OSI层次

## Physical 物理层

### Network Type 网络类型

通讯分为两种：多路复用&点对点

共享介质：主要通过电信号传播——不止是同轴电缆，现在基于hub和双绞线也可以实现

点对点：主要基于光缆，早期的拨号方式也是

### LAN Media 物理层介质

电信号/光信号/无线电波——功能都是传输数据

其转发过程都被成为encoding 编码

通过调幅调频来实现编码

*STP* - Shielded Twisted Pair 屏蔽双绞线

#### UTP 非屏蔽双绞线

*UTP* - Unshielded Twisted Pair 非屏蔽双绞线

两股线绞在一起，一定程度上避免电磁波干扰，相较于STP更便宜，有效范围100m

优点：易于部署/轻便，便宜

缺点：只通过双绞避免噪音，避免噪音能力不强，需要原理大功率电器、范围有限

#### Coaxial 同轴电缆

比较早的传输介质

橡胶套->绝缘膜->金属网->塑胶套 分为细缆(便宜，传输距离小)粗缆(贵，传输距离长，一般500m)

#### Fiber-Optic 光缆

一般两个接口，一个发送，一个接收，成本高

单模：

细，传输损耗小，传输距离远，一般广域网使用

多模：

粗，传输损耗大，可以同时传输多路信号，一般局域网使用

#### Wireless 无线

Lasers 激光 

Infrared

Radio

### UTP for Ethernet 

一类线：主要用于语音传输，不用于数据传输

二类线：传输频率1MHz，用于语音和最高4Mbps的数据传输，常见于令牌网 

三类线：EIA/TIA568标准指定电缆，传输频率16MHz，用于语音传输及最高传输速率为10Mbps的数据传输，主要用于10BASE-T 

四类线：传输频率为20MHz，用于语音传输和最高传输速率16Mbps的数据传输，主要用于令牌网和 10BASE-T/100BASE-T 

五类线：增加了绕线密度，外套高质量绝缘材料，用于语音和数据传输(主要为100/1000BASE-T)，是最常用的以太网电缆 

超五类线：衰减小，串扰少，具有更高的衰减/串扰比和信噪比、更小的时延误差，主要用于1000BASE-T

六类线：传输频率为1MHz～250MHz，性能远高于超五类标准，适用于高于1Gbps的应用

七类线：带宽为600MHz，可能用于今后的10G比特以太网。 

### 网线分类

#### 直通线（Straight cable）：

线的两端都是T568A或T568B

作用：主机连到交换机/交换机连到路由器

#### 反转线（Rollover Cable）：

也叫Console cable 控制台线

一端的插脚1连接另一端的插脚8；然后插脚2连接到插脚7、插脚3连接到插脚6，以此类推

用于把PC连接到交换机或者路由器 连接PC时还要加一个适配器并启用超级终端

#### 交叉线（Crossover）：

一端是T568A，另一端是T568B

可用于连接两个相同的设备，PC与路由器直连，也可用于连接两个或多个集线器或交换机

连接两个独立的工作站以创建迷你局域网

### Media and Signal Problems

Propagation 传播 -- 传播时间：由介质决定

Attenuation 衰减 -- 信号介质和周围干扰都会产生损耗

Noise 干扰

### Collision Domains冲突域

第一层不能解决冲突问题，需要对第一层进行一定的限制，在第二第三层分段

### 数据通信基本知识

#### 基本术语

信号：数据的电气或者电磁的表现

码元：在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。

#### 信号处理

模拟信号可以被分为简单信号和复合信号

​	简单信号（正弦波）不能被分解为更简单的模拟信号

​	复合信号可以被分解为多个**正弦波**

复合模拟信号的分解：**傅立叶分析**

​	任何一个周期为T的有理周期性函数 g(t)可分解为若干项    	（可能无限多项）正弦和余弦函数之和：

```Text
f = 1/T 基本频率；an,bn ：n次谐波项的正弦和余弦振幅值
```

数字信号一般是非周期性的，通常在传输介质上表现为方波

一个数字信号可以分解为无穷多个被称为谐波的简单正弦波，每个谐波都具有不同的频率与相位

在介质上发送数字信号时，其实质是在发送无穷多的简单谐波，如果某些分量未能忠实地通过介质传输，则在接收端将产生信号畸变

由于介质本身的限制，信号畸变是难以完全避免的

任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。 

码元传输的速率越高，或信号传输的距离越远，在信道的输出端的波形的失真就越严重

#### 无噪声信道的最高传输速率

 ![image-20210525153155447](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525153155447.png)

#### 噪声信道的最高传输速率

 ![image-20210525153222995](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525153222995.png)

香农公式含义

- 信道带宽或信道的信噪比越大，极限传输速率越高
- 只要信息传输速率低于信道的极限信息传输速率，就一定有办法实现无差错的传输 
- 若信道的带宽 *W* 或信噪比 *S*/*N* 没有上限（实际不可能），则其极限信息传输速率 *C* 也没有上限
- 实际能够达到的传输速率比香农极限传输速率低不少
- 请注意：对于频带宽度已确定的信道，即使信噪比不能再提高，且码元速率已达上限，也有办法提高传输速率。这就是用编码的方法让每个码元携带更多比特的信息量

### 理论基础

#### 波特率和比特率

波特率（调制速率）：信号每秒钟变化的次数

比特率：每秒钟传送的二进制位数。

波特率与比特率的关系取决于信号值与比特位的关系

例：每个信号值表示为３位，则比特率是波特率的３倍；也就是一个波包含几个比特

对于比特率为a bps的信道，发送８位所需的时间为 8/a秒，若８位为一个周期Ｔ，则一次谐波的频率是：  f = a/8 Hz

### 数据通信技术

#### 调制

把基带信号调制后进行传输  调频/调相

 ![image-20210525155601187](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525155601187.png)

#### 编码方式

##### 1. 单极性编码

0电平表示0，正电平表示1

缺点：难以分辨一位的结束和开始/发送方与接收方必须有时钟同步/若信号中01连续出现，信号直流分量将累加，容易产生传播错误

##### 2. 极化编码

###### 不归零制码 NRZ - None-Return to Zero

负电平表示0，正电平表示1

缺点：难以分辨一位的结束和开始/发送方与接收方必须有时钟同步/若信号中01连续出现，信号直流分量将累加

###### 不归零反相编码

信号电平的一次翻转代表比特1，无电平变化代表0

优于不归零电平编码，可以根据电平跃迁进行有限的同步

###### 归零编码 RZ - Return to Zero

 ![image-20210525160520885](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525160520885.png)

优点：本身带有同步信息，经济型好，不易出错

缺点：需要用三个不同电平，两次变化表示1，占用了很多带宽

###### 曼彻斯特码 Manchester

每一位中间都有一个跳变，从低到高表示0，从高到底表示1 编码率50%

 ![image-20210525160819648](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525160819648.png)

###### 差分曼彻斯特码 Differential Manchester

每一位中间跳变：表示时钟

每一位位前跳变：表示数据 （有跳变 - 0 无跳变 - 1）

​	![image-20210525161158893](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525161158893.png)



##### 3. 双极性编码

###### 双极性传号交替反转码 AMI

零电平表示0，正负电平的跃迁表示1，实现对1电平的交替反转

优点：对每次出现的1交替反转，使直流分量为0/连续的0无法同步，但连续的1可以

#### 多路复用

为了提高线路利用率，经常让多个信号共用一条物理线路

##### 时分复用 TDM Time Division Multiplexing

时分复用是将时间划分为一段段等长的时分复用帧，每个时分复用的用户在每个TDM帧中占用固定序号的时隙。

* 每个用户所占用的时隙时周期性出现的

* TDM信号也称为等时信号

* 时分复用的所有用户在不同的时间占用同样的频带宽度

 ![image-20210525163321591](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163321591.png)

时分复用的浪费：

![image-20210525163508880](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163508880.png)

##### 统计时分复用 STDM Statistic TDM

谁先来就服务谁

![image-20210525163635306](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163635306.png)

##### 频分复用 FDM Frequency Division Multiplexing

用户在分配到一定的频带后，在通信过程中一直占用这个频带

所有用户在同样的时间占用不同的带宽（频率带宽）资源

 ![image-20210525163840676](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525163840676.png)

##### 波分复用 WDM Wavelength Division Multiplexing

光缆的复用，就是光的频分复用

##### 码分复用 CDM Code Division Multiplexing

码分多址 CDMA Code Division Multiple Access

对数据进行编码，各个用户使用不同码型，彼此不干扰

抗干扰能力强

## Data Link Layer 数据链路层

### 概述

第二层只在一个具体链路上，无法跨网段

#### 主要任务

* 错误识别

* 网络拓扑实现
* 流控制，帮助有效传输

#### 第一层与第二层的区别

* 物理层无法与更高层交流，而第二层有此机制，称为LLC（Logical Link Control）
* 共有链路时，物理层无法判断哪个主机可以发送/接受数据，而第二层可以决定
* 物理层无法对主机进行识别，第二层基于MAC地址可以识别
* 物理层之能发送比特流，而第二层可以用帧的形式来组织这些bit
* 物理层只能实现数据传输，无法判断数据对错，数据链路层可以根据数据格式检测并修复错误，接着把数据交给上层

#### 第二层的服务

1. 无确认，无需建立事先连接关系——只发送，不管接收和应答

   需要通讯质量，避免长期不应答引起堆积，常用于LAN

2. 有确认，无需建立事先连接关系

3. 面向连接 一般用于蓝牙连接等事先绑定

#### MAC in Common LANs 局域网介质访问控制

* Ethernet 以太网

  在物理上采用星形或拓展星形，逻辑上为总线

* Token Ring 令牌环

* FDDI 

##### Deterministic 确定性规则

连接的节点组成回路，以此获得令牌并发送/获得信息

如果令牌转了一圈没有节点使用，数据会被丢弃

当传输数据的帧结束了返回到传送主机时，主机重新发送一个令牌，释放它所占用的环

##### Non-deterministic 不确定性规则

先来先用

CSMA/CD Carrier Sense Multiple Access with Collision Detection

避免冲突

#### 局域网通讯的三种方式

1. 单播  一发一收

2. 主播  一个发送方，发给一组特定的接收方，他们有一组特定的进程接收数据

3. 广播  一个发送，向网络内所有节点发送，用于公告/表明身份/请求信息

### 以太网和CSMA/CD

数据链路层被IEEE分为两个部分：LLC and MAC 

LLC:链路服务控制

MAC:介质访问控制

 ![image-20210525201103454](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525201103454.png)

#### MAC

![image-20210525202806567](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525202806567.png)

##### Preamble 前导码

前7个字节的10101010 加10101011 告诉接收站准备开始传输数据帧了

##### Destination and Source physical address

源物理地址：一个单播地址

目的地地址：单播、主播或广播（6字节全1）地址

第二层设备基于MAC地址发送，目的地址放前面可以避免无效解析，加快传输

##### Length 长度

原来用于指定这个帧的长度

在以太网II型标准下，无需长度也能算出

Data长度不能超过1536个字节

IEEE802.3中规定，如果Length / Type的值大于0×600则表示是类型，0x600 = 1536

最小是46字节

6+6+2+46+4=64 **确保发送一次数据占满100m双绞线，不会同时发送**

##### FCS 

用来存放CRC的余数，如果发送方和接收方结果不同则数据错误

![image-20210525204122742](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525204122742.png)

#### LLC

##### 封装

LLC获得网络层的数据（packet）后，对其加入以下两个控制信息进行封装来标志上层协议，然后传递给MAC子层继续进行数据封装

目的服务可达点DSAP/源服务可达点SSAP

#### CSMA/CD

Carrier Sense Multiple Access with Collision Detection

MAC地址 - 48位 烧在网卡上 一般用十二位16进制表示

第一个bit为0—单播，1为主播

第二个bit 0 - global 1 - local 

前24个bits OUI 烧录的厂商购买的描述自己的识别码

后24个bits 每个设备独有

#### 广播地址

目的MAC地址：FFFF.FFFF.FFFF

广播使用场景：目的MAC地址不清楚/目的是全部主机

#### 组帧framing

组帧是第二层封装的过程

帧是第二层的协议数据单元

帧的部分叫做域，每个域由字节构成

#### CSMA/CD传输流程

以太网传输数据时，所有的PC都会接收数据，再根据需求考虑是否丢弃数据

JAM SIGNAL：冲突信号，32位或者更多的1，所有的设备都会接收该信号

所有设备根据回退算法回退一个时间，重新发送

![image-20210525210919107](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210525210919107.png)

### 无线网和CSMA/CD

**a. IEEE 802.11**

一个关键技术：直接序列扩频Direct Sequence Spread Spectrum (DSSS) 

DSSS 适用于操作在1到2 Mbps范围内的无线设备

DSSS 可能操作高达11 Mbps 但超过2Mbps的操作是不兼容的

**WIFI从此产生**

**b. IEEE 802.11b**

也叫Wi-Fi™ 

它将传输能力提升至11 Mbps

所有802.11b系统都是向后兼容的，所以他们也支持802.11的1 到2 Mbps数据传输率

通过使用802.11一个不同的编码技术获得更高的数据吞吐率 

操作在2.4 GHz之内

**c. IEEE 802.11a**

覆盖使用5 GHz传输带宽的WLAN设备 

使用5 GHz

802.11a有能力提供54 Mbps的数据吞吐率，若是使用叫做“双倍率”的专利技术可以到达 

实际上，更标准的速率为20-26 Mbps. 

**d. IEEE 802.11g**

提供和802.11a (54Mbps)一样的吞吐率，但能向后兼容802.11b

使用正交频分多路复用技术(OFDM)技术 

**e. IEEE 802.11n：WLAN的下一代（目前主要使用的）**

提供和802.11g相比两倍的带宽108Mbps，理论上可达500-600Mbps 

### CSMA/CA 

CSMA/CA（Carrier Sense Multiple Access with Collision Avoidance）

无线网络中，发生冲突时，基站只能了解到周围的传输，做不到全部链路监听，因此CSMA/CD并不适用

两个问题：

**hidden station problem**

A -> B <- C A和C信号同时到达B 发生冲突

**exposed station problem**

A <-B C-> D   C监听到B给A的信号，为了避免冲突，不发送给D信号

发送站点在发送数据前，以控制短帧刺激接收站点发送应答短帧，使接收站点周围的站点监听到该帧，从而在一定时间内避免数据发送

 ![image-20210526190629466](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210526190629466.png)

### 第二层设备

#### NIC 网卡

**有LLC的能力** 即可以与更高层交互 对报文接收并且封装

**媒介到达控制** 向共享媒介提供结构化的通路

**命名** 提供一个独特的MAC地址标识

**帧** 封装数据的一个过程，将数据封装成bits

**信号** 通过内置传输装置产生信号并且与媒介相接

#### Bridges 网桥 

网桥将数据分成段，并根据MAC地址来筛选数据，注意，不是根据协议来筛选

通过减少大型冲突的发生，网桥可以提高网络性能 把大的冲突域变成多个小的

**在数据段很少的网络少网桥工作性能最好**  当数据段很多时，网桥就会成为一个瓶颈，降低回话速率 各个链路的带宽无法同时保障

##### 透明网桥

网桥会学习MAC table 

 ![image-20210526192423714](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210526192423714.png)

接收数据帧 接口1 能接收123 接口2 能接受456 但是动态学习 长时间不刷新就会删除掉

* **“透明”**是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的

* 透明网桥是一种即插即用设备，其标准是 IEEE 802.1D

  ​	因为是根据MAC地址来接受发送的 所以可以热插拔 MAC table就能学习好了

*  目前以太网中使用得最多的网桥

* **广播风暴**  当网络上的设备想要发送数据的时候 但是它不知道目的地址就会广播 广播时每个节点都会处理判断并处理接收的数据，会造成性能下降 所以第二层更多的使用交换机

#### Switch 交换机

##### 操作：

* 交换数据帧：从一个接口接收 到另一个端口转发

* 维持交换行为：交换机构建并维持交换表，查找循环，路由器构建并维持路由表和服务表

也可以分割冲突域

母线带宽很高 可以按逻辑分配 支持各个段的完全带宽

如果目的帧不在MAC table内 会广播

速度相较于网桥快很多 可以快速转发不做校验 保证速率

第二层的设备不能做广播域的隔离

路由器既可以屏蔽广播 也可以packet检查 根据逻辑地址转发 路由器可以做很多事 所以延时长

## Network Layer 网络层

### 网络层概述 

第二层用MAC定位主机，但全球几十亿个主机，很难全部使用MAC定位，需要新的逻辑定位主机，且逻辑需要一定的抽象性

第三层希望通过一个统一的逻辑，即路由选择算法，在逻辑上进行路径选择。该逻辑对第二层透明，因此做到了不同网段的互连

#### 第三层的责任

* 通过网络传递数据

* 使用分层的寻址方案（不同于水平的MAC寻址——第二层寻址方案）
* 网段与数据流控制
* 减少拥堵
* 与其他网段相通
* 向下屏蔽不同介质的差异

 ![](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\1.png)

### IP 地址和子网划分

 ![](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\2.png)

#### 首部

**版本** 占4bit 表示IPV4/IPV6

**首部长度** 占4bit 可表示最大15个单位（一个单位是一行四个字节） 因此IP首部长度最大值为60字节 可变部分最大长度40字节

**服务类型** 占8bit 用来后的更好的服务 以前一直没有被使用

**总长度** 占16bit 首部和数据之和的长度 单位为字节 最大65535 一般不超过1500

**标识** 占16bit 和标记/位偏移共同使用 不是为了确认 只是为了报文分配 

​	如一个无线大报文拆成两个有限小报文发出 转发后需要进行合并 这就可以根据标识号来决定

**标志** 占3bit 最高位为0 DF(don't fragment)为0时允许分配 MF(more fragment)为0表示最后一个分片

**片偏移/位偏移** 占12bit 较长的分组在分片后 某片在原分组中的相对位置 以8个字节作为偏移单位

例

分片的时候，`每个片的长度都要是8的倍数`

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\3.png" style="zoom:50%;" /><img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\4.png" style="zoom:50%;" />

 **生存时间** 占8bit TTL(Time To Live) 数据报在网络中可通过的路由器数的最大值 最大值为255

路由器每转发一次 TTL减1 到0时将报文丢弃 同时告诉源地址报文被丢弃 **可以避免网络中冗余的回路或将TTL置为1用来传给相邻的路由器**

**协议** 占8bit 指出数据报携带数据采用何种协议处理 

**首部校验和** 占16bit 与第二层循环冗余除法校验不同 这里只有两个字节 做的是反码算数求和 发送方计算完后得到的校验和会在接收端取反码 如果结果为0 则保留 否则丢弃该数据报

**源地址**和**目的地址**各占4字节

#### 网络层地址

IP地址32位长 一般写成4个字节中间用点分开的样式

一般IP地址前段是networkID，后段是HostID

networkID用来区分网段，需要Internet管理组织分配 host则不需要，由局域网的管理员分配来标识网段内特定的设备

##### IP地址分类

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\5.png" style="zoom:67%;" />

##### 主机数

不同类别的主机最大数量是不同的

A类网络中n最多有16,777,214 个主机(2^24 –2)

B类网络中最多有65,534 个主机(2^16 –2)

C类网络中最多有254个主机(2^8 –2)

每个网络中的第一个地址（即主机号全为0）是预留(reserved)的网络地址，表示本机所连接的网络地址

最后一个地址（即主机号全为1）预留的，用于广播

例：

113.0.0.0 只能用来标识网段 不能分配给主机 

176.10.255.255 广播地址

255.255.255.255 受限广播地址 适用于所有网段 但无法跨路由器转发

##### IP寻址

**私有地址空间**

**10.0.0.0       -  10.255.255.255**

**172.16.0.0   -  172.31.255.255**

**192.168.0.0 -  192.168.255.255**

有一些IP地址范围预留给私有IP地址空间 避免网络IP被耗尽

IP 地址损耗 和它的解决办法 :

​	NAT（网络地址转换Network Address Translation）

​	CIDR（无类别域间路由，Classless Inter-Domain Routing）

​	IPv6（Internet Protocol Version 6互联网协议）

#### 子网

A类网B类网主机数很多，但很难有大数量主机组成子网的情况 因此可以根据IP地址来划分多个子网并进行分配

* 子网是网络的小划分——提供寻址的灵活性

* 子网地址通常由网管分配

* 子网减少了广播域

**借位**

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\6.png" style="zoom:50%;" />

最少借两位 如果只借1位 子网取0 host取0 和网络位相同 子网取1 host取1 和广播位相同 产生混淆

最多需要给host留2位 如果只留1位 那只有网络位和广播位 不能使用

借位副产物：**地址的浪费**

 ![](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\7.png)

##### 子网掩码

将前面的网络位都写成1 后面的host位都写成0

Class A: 255.0.0.0

Class B: 255.255.0.0

Class C: 255.255.255.0

**计算子网的划分**

例 将223.14.17.0进行子网划分，使得IP拥有13个子网，每个子网有10个主机

1. 确定网络类型 -> C类网络 子网掩码：255.255.255.0

2. 需要13个subnet，每个net10个主机，借2,3,5,6都不行 只能借4位

3. 借4位，有16-2=14个子网，

4. IP最后一个字节的前4位都为1来得到子网掩码，即11110000，前28位都是1，就是240，因此子网掩码是255.255.255.240

5. 14个可用的子网，每个子网14个可用的主机

**通过子网掩码计算NetworkID**

1. 将IP和子网掩码换成二进制

2. 两个数做布尔加法

3. 得到的结果转十进制

例 IP 172.16.2.120 子网掩码 255.255.255.0

布尔加法转十进制 -> 172.16.2.0

**可以帮助主机决定目的IP地址是否和本机同一个网段 如果是 直接发送 否则先发送给网关**

路由器也会做类似的运算来决定报文发送到哪个网段

### 第三层设备

#### 路由器

主要工作：path determination 路径选择/报文转发

#### IP地址

基于逻辑地址，不像MAC是写死的，IP可以动态配置，只要传到网段就可以

整体流程 **寻找路径 -> 转发 ->报文交换**

![image-20210531001027039](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531001027039.png)

A5发给B5，数据帧目的地址是B5的IP地址，先以A1为目的地址发送到路由器，查找路由表后，从A1到B1并形成新的数据帧，目的地址是B5的MAC地址，源地址是B1的MAC地址，如果是A5的MAC地址则无法到达，无意义

#### 路由接口

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531001434574.png" alt="image-20210531001434574" style="zoom:50%;" />

一个路由器通过接口连接到网络，接口也可能指IP路由中的一个端口

每一个接口都有一个单独的、独特的网络地址

#### IP地址分配

##### 静态地址分配

​	给每一个设备配置一个IP地址

​	你应该保留非常细致的记录，因为一旦你是用的重复的IP地址，问题就来了

##### 动态地址分配

​	这里有一些可以动态分配地址的不同方法：

​		–RARP: Reverse Address Resolution Protocol.逆向地址解析协议

​		–BOOTP: BOOTstrap Protocol.自举协议

​		–DHCP: Dynamic Host Configuration Protocol.动态主机配置协议(我们一般使用这种方式)

### ARP协议 

Address Resolution Protocol 地址解析协议 根据IP地址信息获得MAC地址

ARP 使得一台电脑可以获取与一个IP地址相关的MAC地址

#### ARP操作

ARP中的ARP table类似Switch中的MAC table，可以学习

1. 广播询问MAC地址(请求) 将目的MAC设为全1 ff.ff.ff.ff
2. IP地址匹配(检查)
3. 对应主机回复自己的MAC地址(应答)
4. 根据ARP缓存表发送数据帧(ARP缓存表中每个条目具有一定的生命周期)(缓存)

**但广播不能跨网段，如果不在一个网段内怎么办？**

1. 默认网关

   为了让一个设备可以和别的网络中的设备通讯，你必须给它提供一个默认网关

   默认网关是连接来源主机所处的网段的路由接口的IP地址

   为了让一个设备可以给其它网段上的设备发送数据，来源设备将数据发送到默认网关

2. 代理ARP

   代理ARP是ARP的一种变化形式 

   这种情况下，来源主机没有配置默认网关 

   如果ARP请求发现目的地址不在本网段，就把本网段连接路由器的端口返回

   到路由器另一个端口时广播找目的地址

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531003045883.png" alt="image-20210531003045883" style="zoom:50%;" />

**ARP攻击**

利用ARP缓存机制，一直写死，这样就无法上网

### 网络层服务

#### 面向连接的网络服务

传输数据前会在发送者和接受者之间建立连接，代价高，但可靠

#### 虚电路交换

强于面向连接，所有报文按顺序在连接的虚电路上传输，整个虚电路无法复用，效率低，但不用路径选择

#### 无连接

发送方直接向目的方传输，适用于突发性传输，可能丢失

#### 报文交换

原始数据分为很多子报文，每个子报文各自发送

### Routed and Routing Protocols

Routed Protocols用在路由器之间，做转发的判断，从而使得路由器能够有效连通，基于第三层

Routing Protocols用在路由器之间，不负责转发，做的是动态路由表的生成，基于路由表来做Routed Protocols

#### 分类

##### 静态 & 动态

静态路由:

​	网关手动将路由信息输入路由器 

动态路由:

​	路由器可以联机（on the fly）交换彼此信息

​	使用路由（routing）协议来更新路由信息

​	RIP, IGRP, EIGRP, OSPF …

**静态路由VS动态路由**

静态路由:

​	隐藏了部分互联网

​	测试网络中某个特定的链接

​	当只有一条路径到达目的网络时，便于维持路由表

动态路由:

​	维持路由表

​	定时更新路由信息

​	基于路由（routing）协议，共享路由信息

​	路由器可以适应变化的网络条件 

##### IGP & EGP

动态路由

**I**nterior **G**ateway **P**rotocols (RIP, IGRP, EIGRP, OSPF)内部网关协议: 

自治系统中的协议，管理局域网中的路由器，如：校园网，公司内网……

**E**xterior **G**ateway **P**rotocols (EGP, BGP)外部网关协议:

用于自治系统之间传送包

##### DVP & LSP

**D**istance-**V**ector **P**rotocols (RIP, IGRP)距离矢量协议:

​	从相邻的视角看网络拓扑

​	路由器之间添加距离矢量

​	周期性频繁的更新

​	复制一份路由表，传给相邻路由器

**L**ink **S**tate **P**rotocols (OSPF)链路状态协议:

​	了解整个网络拓扑

​	计算去其它路由的最短路径

​	**由事件触发更新**

​	把链路状态路由的更新信息发给其它路由

#### RIP(Route Information Protocol)路由信息协议

最受欢迎

属于内部网关协议、距离矢量协议

跳数hop是唯一的度量标准，短板，评判依据简单

最大跳数为15

每30秒更新一次

不总是选择最快路径，选择跳数最少的路径

产生很多网络拥塞

RIP v2 是 RIP v1的一个很重要的改进版本

#### IGRP(内部网关路由选择协议)&EIGRP(增强网关路由选择协议)

思科专利

属于内部网关协议、距离矢量协议

综合以延迟，带宽，负载，可靠性为度量标准

最大跳数为255

每90秒更新一次

EIGRP 是 IGRP的进阶版, 混合了路由（routing）协议

#### OSPF(Open Shortest Path First)开放最短路径优先

标准的lsp 主要基于带宽 内存CPU消耗比DV高

属于内部网关协议、链路状态协议

综合以代价，速度，可靠性，安全性为衡量

由事件触发更新

### VLSM Variable Length Subnet Mask 可变长子网掩码

**有类路由**

​	有类路由协议要求一个网络只能有一个子网掩码

​	示例：网络192.168.187.0必须只使用一个子网掩码如255.255.255.0

**VLSM-可变长子网掩码**

​	VLSM的优点是允许一个自治系统有不同的子网掩码

有了VLSM，网管可以在少量主机的网络上使用长子网掩码，大量主机的网络上使用短子网掩码

如果路由协议允许VLSM：

​	在网络连接上使用一个30位的子网掩码，255.255.255.252

​	给用户网络一个24位的掩码，255.255.255.0

​	或者，甚至一个22位的掩码，255.255.252.0，给有着近1000用户的网络

优点:

​	更有效的使用IP地址 

​	使用路由汇总的能力更强

支持 VLSM 的路由协议:

​	OSPF开放最短路径优先

​	Integrated Intermediate System to Intermediate System (Integrated IS-IS) 

​	EIGRP增强内部网关路由选择协议

​	RIP v2 

​	静态路由

空间浪费：

​	过去建议不要使用第一个和最后一个子网，但是我们可以在Cisco IOS ver12.0中使用子网

​	在 IOS ver12.0 中, 思科路由器默认使用子网0  

​	命令：router(config)#no ip subnet-zero 

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115310841.png" alt="image-20210531115310841" style="zoom:50%;" />

一个C类地址192.168.10.0/24 (表示前24位为网络号)已经被分配

​	珀斯，悉尼，新加坡有一个连接到KL的广域网

​	珀斯需要60个主机

​	KL 需要28个主机.

​	悉尼和新加坡各需要12个主机

为了计算VLSM子网和各自的主机数，在地址范围中先分配最大的需求。需求水平应该按照从大到小的顺序排列。

**步骤一**

珀斯需要60个主机

用6位，因为这样有2^6-2=62个可用主机地址，因此第4个八位中的2位将表示/26的扩展网络前缀，剩余的6位用来表示主机地址

将VLSM用在地址192.168.10.0/24上，有：

​	192.168.10.00 hhhhhh/26

​	255.255.255.192(1100 0000)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115727941.png" alt="image-20210531115727941" style="zoom:50%;" />

**步骤二**

KL需要28个主机。在192.168.10.63/26后，下一个可用的地址是192.168.10.64/26

因为需要28个主机，所以需要5位表示主机地址，这样有2^5-2=30个可用的主机

因此需要5位来表示主机，3位用于/27的扩展网络前缀

将VLSM使用在192.168.10.64/26上，有：

​	192.168.10.**010** hhhhh/27

​	255.255.255.224(1110 0000)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115749759.png" alt="image-20210531115749759" style="zoom:50%;" />

**步骤三**

现在悉尼和新加坡各需要12个主机，下一个可用地址从192.168.10.96/27开始

因为需要12个主机，所以需要4位表示主机地址，有2^4-2=14个可用地址

因此4位代表主机，4位用于/28的扩展网络前缀

将VLSM用在192.168.10.96/27上，有：

​	192.168.10.**0110** hhhh/28

​	255.255.255.240(1111 0000)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115801671.png" alt="image-20210531115801671" style="zoom:50%;" />

**步骤四**

现在给广域网分配链接地址，记住，每个广域网链接需要2个IP地址，下个可获取的子网是192.168.10.128/28

因为每个广域网链接需要2个网络地址，所以2位用于表示主机，有2^2-2=2个可用地址

因此需要2位表示链接，6位表示/30的扩展网络前缀

将VLSM用在192.168.10.128/28上，有：

​	192.168.10.**100000** hh/30

​	255.255.255.250(1111 1100)

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115820879.png" alt="image-20210531115820879" style="zoom:50%;" />

**result**

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531115834900.png" alt="image-20210531115834900" style="zoom:50%;" />

只有没有被使用的子网可以被进一步划分子网

如果一个子网的任何地址被使用了，那么这个子网不能再被划分

### 路由聚集 Route Aggregation

无类别域间路由和VLSM的使用，不仅防止了地址浪费，还促进路由聚合 

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120056154.png" alt="image-20210531120056154" style="zoom:50%;" />

**示例**

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120216315.png" alt="image-20210531120216315" style="zoom:50%;" /> 

**计算**

<img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120244620.png" alt="image-20210531120244620" style="zoom:67%;" /> 

**优点**

​	减少路由表条目数

​	用于隔离拓扑的变化

**注意**

​	为了让聚合正确工作，要仔细地在层次结构中分配地址，使得汇总的地址分享同样的高位比特 

​	VLSM 允许路由聚合，通过将聚合完全基于左边共享的高位，来增加灵活性，即使网络是不连续的。

### ICMP

ICMP (Internet Control Message Protocol)：为了提高 IP 数据报交付成功的机会

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告

ICMP 只是 IP 层的协议

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去

#### ICMP报文格式

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531120909893.png" alt="image-20210531120909893" style="zoom:50%;" />

#### 两种ICMP报文

 <img src="C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531121023870.png" alt="image-20210531121023870" style="zoom:50%;" />

#### 目的站不可到达

**网络不可到达**(net unreachable)

**主机不可到达**(host unreachable)

**协议不可到达（**protocol unreachable）

**端口不可到达（**port unreachable）

**源路由选择不能完成（**source route failed）

**目的网络不可知（**unknown destination network）

**目的主机不可知**（unknown destination host）

#### ICMP差错报告报文的数据字段的内容

![image-20210531121139610](C:\Users\Edward\AppData\Roaming\Typora\typora-user-images\image-20210531121139610.png)

#### 不应发送ICMP差错报告报文的几种情况

* 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文

* 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文

* 对具有多播地址的数据报都不发送 ICMP 差错报告报文

* 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送 ICMP 差错报告报文

#### PING(Packet InterNet Groper)

PING 是用ICMP的"Echo request"和"Echo reply"消息来实现的

PING 用来测试两个主机之间的连通性

PING 使用了 ICMP 回送请求与回送回答报文

PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP或UDP